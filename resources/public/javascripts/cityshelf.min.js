var CityShelf=angular.module("CityShelf",["ngResource","ngRoute","ionic","google-maps"]);CityShelf.controller("GeolocationCtrl",["$scope","$location","Geolocation",function(a,b,c){"use strict";a.form={},a.error=c.getError(),a.geolocate=function(){c.geolocate(a.form.location),b.path("/search")}}]),CityShelf.controller("MainCtrl",["$scope","$location","$route","Search","Geolocation",function(a,b,c,d,e){"use strict";function f(a,b){setTimeout(function(){b()},a)}var g=7;a.form={},a.loading=!1;var h=function(a){var c;c=1===a.code?"Okay!":"Oops, we can't find you.",e.setError(c),b.path("/geolocation")};a.setLocation=function(){f(3e3,function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){e.set(a.coords.latitude,a.coords.longitude),b.path("/search"),c.reload()},h,{maximumAge:6e5,timeout:3e3,enableHighAccuracy:!1}):(b.path("/geolocation"),c.reload())})},a.search=function(){a.loading=!0,e.fetch().length?f(3e3,function(){b.path("/search"),c.reload()}):a.setLocation(),d.flush();for(var h=0;g>h;h++)d.execute(a.form.book,h)}}]),CityShelf.controller("SearchCtrl",["$scope","$http","$location","$ionicScrollDelegate","Search","Geolocation",function(a,b,c,d,e,f){"use strict";var g=a.results=e.fetch();a.options=["proximity","price"];var h=function(){console.log("Scrolling to top!"),d.scrollTop()};a.sortBy=function(){return function(b){return"price"===a.selected?+b.price:"proximity"===a.selected?f.proximity(f.fetch(),[b.map.center.latitude,b.map.center.longitude]):b.availability}},a.selected=a.options[0],a.select=function(b){a.selected=b};var i=!1;a.filter=function(b,c){i?(a.results=g,i=!1):(a.results=a.results.filter(function(a){return a[b]===c}),i=!0),h()},a.back=function(b){i?(a.results=g,i=!1,h()):c.path(b)},a.showSearch=!0,a.showMap=!1,a.searchQuery=e.getQuery()}]),CityShelf.filter("capitalize",function(){"use strict";var a=["a","an","as","at","and","but","for","from","in","is","of","on","the","to"],b=function(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1};return function(c){if(c){for(var d=c.split(" "),e=[],f=0;f<d.length;f++)e.push(b(a,d[f])&&0!==f?d[f]:d[f].charAt(0).toUpperCase()+d[f].substr(1).toLowerCase());return e.join(" ")}return""}}),CityShelf.filter("truncate",function(){"use strict";return function(a,b,c){return isNaN(b)&&(b=35),void 0===c&&(c="..."),a.length<=b||a.length-c.length<=b?a:String(a).substring(0,b-c.length)+c}}),CityShelf.config(["$routeProvider","$locationProvider",function(a,b){"use strict";a.when("/",{controller:"MainCtrl",templateUrl:"templates/main.html"}).when("/search",{controller:"SearchCtrl",templateUrl:"templates/search.html"}).when("/geolocation",{controller:"GeolocationCtrl",templateUrl:"templates/geolocation.html"}).otherwise({templateUrl:"templates/404.html"}),b.html5Mode(!0),b.hashPrefix("!")}]),CityShelf.factory("Geolocation",[function(){"use strict";var a="",b=function(b){a=b},c=function(){return a},d=function(a,b){return Math.sqrt(Math.pow(a[0]-b[0],2)+Math.pow(a[1]-b[1],2))},e=[],f=function(a,b){e=[a,b]},g=function(){return e},h=function(a){var b=new google.maps.Geocoder,c=a;b.geocode({address:c},function(a,b){if(b===google.maps.GeocoderStatus.OK){var c=a[0].geometry.location.k,d=a[0].geometry.location.B;f(c,d)}})};return{fetch:g,geolocate:h,getError:c,proximity:d,set:f,setError:b}}]),CityShelf.factory("Search",["Store",function(a){"use strict";var b=[],c="",d=function(d,e){c=d,a.query({id:e,query:d}).$promise.then(function(a){b=b.concat(a)})},e=function(){return b},f=function(){b=[]},g=function(){return c};return{execute:d,fetch:e,flush:f,getQuery:g}}]),CityShelf.factory("Store",["$resource",function(a){"use strict";return a("/api/stores/:id/?query=:query",{id:"@id"})}]);